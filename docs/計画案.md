# 計画案

## 概要

このプロジェクトは、小説執筆を補助するためのObsidianプラグイン「Novelaid Tools」を開発する。
Gemini APIを活用し、執筆の効率化と質の向上を目指す。

## 機能一覧

### 生成AIを必要とする機能

- [ ] 1. **キャラクター設定支援機能**
    - [ ] 1.1. キャラクターの基本情報（名前、年齢、性別など）を入力すると、性格や背景を自動生成する。
- [ ] 2. **プロット作成支援機能**
    - [ ] 2.1. 物語のテーマやジャンル、登場人物などを入力すると、プロットの骨子を提案する。
    - [ ] 2.2. 三幕構成や起承転結などのテンプレートに沿ったプロット生成。
- [x] 3. **文章推敲・校正機能（AI活用）**
    - [x] 3.1. 誤字脱字のチェック（AIによる校正機能を実装済み）
    - [x] 3.2. 表現の揺らぎを指摘・修正案を提示（AIによる校正・レビュー機能を実装済み）
    - [ ] 3.3. 文章をより豊かにするための類語提案
- [x] 4. **チャット形式での相談機能**
    - [x] 4.1. 執筆に行き詰まった際に、AIに相談できるチャットUIを提供（ChatViewの基礎実装済み）
- [ ] 5. **AIによるタイトル・あらすじ生成**
    - [ ] 5.1. 作品タイトルやあらすじの自動提案
- [ ] 6. **物語の構成分析機能**
    - [ ] 6.1. 5W1H（Who, When, Where, What, Why, How）の要素が文章に含まれているかをチェックする。
    - [ ] 6.2. 起承転結など、物語の基本的な構造が満たされているかを評価する。
    - [ ] 6.3. 分析結果に基づき、構成の過不足や改善点を提案する。


### 生成AIを必要としない機能

- [ ] 7. **キャラクタービュー機能**
    - [ ] 7.1. サイドバーに専用ビューを追加し、特定のタグを持つキャラクターファイルの一覧を表示する。
    - [ ] 7.2. ファイル名での並び替え、更新順での並び替え機能。
    - [ ] 7.3. ファイル名でのフィルタリング機能。
    - [ ] 7.4. 設定画面でキャラクター認識用のタグをカスタマイズできる機能。
- [x] 8. **ルビ振り機能**
    - [x] 8.1. 漢字に対して自動でルビを振る（Markdown記法対応済み）
    - [x] 8.2. **ポップアップメニューによるルビ挿入機能**
        - [x] 8.2.1. テキスト選択時の右クリックメニューからルビを挿入する。
        - [x] 8.2.2. ルビ文字入力用のモーダルUIを提供する。
        - [x] 8.2.3. カクヨム記法 (`|親文字《ルビ》`) 形式でテキストを置換する。
- [x] 9. **日付入力機能**
    - [x] 9.1. 右クリックメニューからDatePickerを開き、カーソル位置に日付を `YYYY-MM-DD` 形式で挿入する。
- [ ] 10. **プロジェクト管理・章立て支援**
    - [ ] 10.1. 章・話ごとの構成管理、並び替え
    - [ ] 10.2. 執筆メモやTODOの管理
- [ ] 11. **用語集・世界観設定支援**
    - [ ] 11.1. 固有名詞や設定の一元管理
    - [ ] 11.2. 設定の自動抽出・整理
- [ ] 12. **小説分析機能**
    - [ ] 12.1. **文体・表現の分析**
        - [ ] 12.1.1. 品詞の割合分析（名詞、動詞、形容詞など）
        - [ ] 12.1.2. 文の長さの分布分析
    - [ ] 12.2. **登場人物の分析**
        - [ ] 12.2.1. 登場人物の出現頻度・相関分析

### 設定・その他

- [x] 13. **Gemini AIモデル選択機能**
    - [x] 13.1. 設定画面で、使用するGeminiのモデルを選択可能にする。（例: `gemini-1.5-flash`, `gemini-1.5-pro`）
    - [x] 13.2. プルダウンにないモデル名を任意で入力できるカスタムオプションを追加する。
- [x] 14. **AI接続テスト機能**
    - [x] 14.1. 設定画面に、入力されたAPIキーと選択されたモデルでGemini APIへ接続テストを行うボタンを設置する。
    - [x] 14.2. 接続結果（成功・失敗）をユーザーに通知する。

### 追加しない機能（記録・管理系）

以下の機能は本プラグインの主目的（創作支援・AI活用）から外れるため、現時点では追加しません。ユーザーの執筆活動や生活リズムの管理は他ツールやObsidian標準機能で代替可能と判断しています。

- [ ] A. **執筆進捗管理機能**
    - [ ] A.1. 目標文字数や進捗グラフの表示
    - [ ] A.2. 日ごとの執筆記録・統計
- [ ] B. **執筆リズム支援（タイマー・ポモドーロ）**
    - [ ] B.1. 集中タイマーや休憩通知


## 実装状況

- 2025/07/20: プロジェクト初期設定完了。計画案作成。
- 2025/07/20: 文章推敲・校正機能、ルビ振り機能、チャットUIの基礎実装完了。
- 2025/11/03: ポップアップメニューによるルビ挿入機能の実装完了。
- 2025/08/02: コンテキスト取得処理のリファクタリングに着手。
- 2025/08/03: Gemini AIモデルの選択機能の実装完了。
- 2025/08/03: AI接続テスト機能の実装完了。
- 2025/09/15: 物語の構成分析機能の計画に着手。
- 2025/11/22: 右クリックメニューからの日付入力機能の実装完了。

## 今後の課題・TODO

- **キャラクタービュー機能の実装**
    - **目的:** 小説の登場人物一覧をサイドバーに表示し、キャラクター設定へのアクセスを容易にすることで、執筆効率を向上させる。
    - **計画:**
        - Obsidianの`ItemView`を継承した`CharacterView`クラスを`src/ui/`に作成する。
        - `main.ts`でビューの登録処理を追加し、サイドバーにアイコンを表示させる。
        - Vault内の全Markdownファイルをスキャンし、設定されたタグを持つファイルを抽出するロジックを実装する。
        - 抽出したファイルをビューに一覧表示し、クリックでファイルを開けるようにする。
        - 並び替え、フィルタリング機能のUIとロジックを実装する。
        - 設定画面(`src/novelaidToolsSettingsTab.ts`)に、キャラクター認識用タグのカスタマイズ機能を追加する。
- **物語の構成分析機能の実装**
    - **目的:** 執筆中の文章が物語の構成要素（5W1H、起承転結など）を満たしているかAIが分析し、改善点を提案することで作品のクオリティ向上を支援する。
    - **計画:**
        - AIに構成分析をさせるためのプロンプトと、結果を受け取るためのJSONスキーマを設計する。
        - `AiOrchestratorService` に分析用のメソッドを追加する。
        - コマンドパレットから分析を実行できるようにし、結果を `ChatView` に分かりやすく表示する。
- **コンテキスト取得処理のリファクタリング**
    - **目的:** 生成AIに与えるコンテキスト（アクティブなファイル、フォルダ内のファイル一覧など）を取得するロジックを、再利用可能なサービスとして独立させる。
    - **計画:**
        - `src/services/obsidianContextService.ts` を新設する。
        - ObsidianのAPIを直接利用している箇所を新サービスに集約し、各機能（ChatView, geminiService等）は新サービスを経由してコンテキスト情報を取得するように修正する。
        - これにより、コードの再利用性を高め、将来的な機能拡張（例: ファイル横断的な情報提供）を容易にする。
- 校正機能のUIデザイン改善
    - 現状は「校正前」「校正後」「理由」が横並び（3列）で表示されているが、縦長ペインでは視認性が悪い。
    - 「校正前」「校正後」「理由」を縦方向に並べて表示するレイアウトを検討する。
    - 校正前・校正後の差分や理由が一目で分かるよう、色分けや強調表示などデザイン面も改善する。


## 開発マイルストーン

- **フェーズ1（～2025/08）: 基本機能の実装とリファクタリング**
    - [x] 3. 文章推敲・校正機能
    - [x] 4. チャット形式での相談機能
    - [x] 8. ルビ振り機能
    - [ ] コンテキスト取得処理のリファクタリング
    - [x] 12. Gemini AIモデル選択機能
    - [x] 13. AI接続テスト機能- **フェーズ2（～2025/09）: 支援機能の拡充**
    - [ ] 1. キャラクター設定支援機能
    - [ ] 2. プロット作成支援機能
    - [ ] 6. 物語の構成分析機能
    - [ ] 7. キャラクタービュー機能
- **フェーズ3（～2025/10）: 分析・管理機能の追加**
    - [ ] 11. 小説分析機能
    - [ ] 9. プロジェクト管理・章立て支援
- **フェーズ4（リリース後）: 改善・高度化**
    - [ ] ユーザーフィードバックに基づく改善
    - [ ] AIモデルのアップデート対応
    - [ ] パフォーマンスチューニング
